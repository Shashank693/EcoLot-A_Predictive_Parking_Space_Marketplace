{% extends "base.html" %}

{% block title %}User Summary{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar me-2"></i>My Parking Summary</h2>
    <a href="{{ url_for('user_dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
    </a>
</div>

<!-- User Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-gradient-primary text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-rupee-sign fa-2x mb-2 opacity-75"></i>
                <h3>â‚¹{{ current_user.get_total_spending() }}</h3>
                <p class="mb-0">Total Spending</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-gradient-success text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2 opacity-75"></i>
                <h3>{{ current_user.get_total_hours() }}</h3>
                <p class="mb-0">Total Hours</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-gradient-info text-white shadow">
            <div class="card-body text-center">
                <i class="fas fa-parking fa-2x mb-2 opacity-75"></i>
                <h3>{{ current_user.get_parking_frequency() }}</h3>
                <p class="mb-0">Total Bookings</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row">
    <!-- Location Frequency Chart -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5><i class="fas fa-map-marker-alt me-2"></i>Booking Frequency by Location</h5>
            </div>
            <div class="card-body text-center">
                {% if location_chart_url %}
                    <img src="{{ location_chart_url }}" class="img-fluid" alt="Location Frequency Chart" style="max-width: 100%; height: auto;">
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No location data available</h5>
                        <p class="text-muted">Start booking parking spots to see your location preferences.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Duration Chart -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5><i class="fas fa-clock me-2"></i>Parking Duration Over Time</h5>
            </div>
            <div class="card-body text-center">
                {% if duration_chart_url %}
                    <img src="{{ duration_chart_url }}" class="img-fluid" alt="Duration Chart" style="max-width: 100%; height: auto;">
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No duration data available</h5>
                        <p class="text-muted">Complete some parking sessions to see your duration patterns.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Statistics -->
{% if location_bookings or duration_data %}
<div class="row mt-4">
    <!-- Location Breakdown -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h6><i class="fas fa-list me-2"></i>Location Breakdown</h6>
            </div>
            <div class="card-body">
                {% if location_bookings %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Bookings</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_bookings = location_bookings|map(attribute=1)|sum %}
                                {% for location, count in location_bookings %}
                                <tr>
                                    <td>{{ location }}</td>
                                    <td><span class="badge bg-primary">{{ count }}</span></td>
                                    <td>{{ ((count / total_bookings) * 100)|round(1) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No location data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Sessions -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h6><i class="fas fa-history me-2"></i>Recent Sessions</h6>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% if duration_data %}
                    {% for session in duration_data[-10:] %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <small class="fw-bold">{{ session.location }}</small><br>
                            <small class="text-muted">{{ session.date }}</small>
                        </div>
                        <span class="badge bg-info">
                            {% if session.hours >= 1 %}
                            {{ session.hours|round(1) }}h
                            {% else %}
                            {{ (session.hours * 60)|int }}m
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No session data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body text-center">
                <h6 class="mb-3">Quick Actions</h6>
                <a href="{{ url_for('user_dashboard') }}" class="btn btn-primary me-2">
                    <i class="fas fa-search me-1"></i>Find Parking
                </a>
                <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-user-edit me-1"></i>Edit Profile
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
